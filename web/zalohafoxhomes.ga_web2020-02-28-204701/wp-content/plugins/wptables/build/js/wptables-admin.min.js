!function(t){"use strict";window.wpt_admin={},window.wpt_admin.view={},window.wpt_admin.selectText=function(t){if(document.selection)(e=document.body.createTextRange()).moveToElementText(t),e.select();else if(window.getSelection){var e=document.createRange();e.selectNodeContents(t),window.getSelection().removeAllRanges(),window.getSelection().addRange(e)}},window.wpt_admin.view.list_tables=function(){t(".wpt-delete").click(function(t){confirm(wpt_consts.confirm_delete_table)||t.preventDefault()}),t(".wpt-shortcode").click(function(){wpt_admin.selectText(this)}),t(".wpt-subscribe-btn").click(function(){})},window.wpt_admin.view.add_new=function(e){function n(){t("#db-table").empty(),t("#db-table").prop("disabled",!1);var n=e.dbs[t("#db-name").val()];n&&n.forEach(function(e){t("#db-table").append(t("<option>").val(e).text(e))})}function i(t){t.closest(".wpt-ds-box-content").find("#input-type").val(t.attr("data-type"))}function a(e){t("#wpt-error-file-wrong-type",this).hide(),t("#wpt-filename",this).text(e?e.name:"")}function o(e){t("#wpt-error-file-wrong-type",this).show()}t(".wpt-ds-item").click(function(){var e=t(this).attr("data-value");t(".wpt-ds-item").toggleClass("wpt-active",!1),t(this).toggleClass("wpt-active"),t("#wpt-format").val(t(".wpt-ds-item.wpt-active").attr("data-value")),t("#wpt-ds-box .wpt-ds-box-content").hide(),t("#wpt-ds-box #wpt-ds-box-"+e).show(),t("#wpt-ds-box").show()}),t("#wpt-ds-box-csv").wptTabs({change:i}),t("#wpt-ds-box-csv #wpt-drop-zone").wptFileDrop({change:a,error:o}),t("#wpt-ds-box-json").wptTabs({change:i}),t("#wpt-ds-box-json #wpt-drop-zone").wptFileDrop({change:a,error:o}),t("#wpt-ds-box-mysql").wptTabs({change:i}),t("#db-name").change(n),n()},window.wpt_admin.view.edit_table=function(e){function n(){return g||v||b}function i(){b=!0}function a(n,i){0==i.length&&i.push(o(e.fields));var a=new Handsontable(n,{data:i,rowHeaders:!0,colHeaders:l(e.fields),columns:p(e.fields),allowInsertColumn:!1,allowRemoveColumn:!1,manualRowMove:!0,stretchH:"all",cells:function(t,e,n){return y[n]?{className:_[y[n].align]}:null},contextMenu:{callback:function(t,e){if("alignment:center"==t||"alignment:left"==t||"alignment:right"==t){var n=a.getCellMeta(e.start.row,e.start.col),i=t.replace("alignment:","");y[n.prop].align=i,d(n.prop,"align",i),a.render()}},items:{row_above:{},row_below:{},hsep1:"---------",remove_row:{},hsep2:"---------",alignment:{submenu:{items:[{key:"alignment:left",name:"Left"},{key:"alignment:center",name:"Center"},{key:"alignment:right",name:"Right"}]}},hsep3:"---------",undo:{},redo:{},hsep4:"---------",copy:{},cut:{}}},afterChange:function(t,e){"loadData"!=e&&(g=!0)},afterRemoveRow:function(){g=!0},afterCreateRow:function(){g=!0},afterRender:function(e){if(e){var n=t(".wtHider").height();t("#wpt-data-sheet").height(Math.max(200,Math.min(n,500)))}}});return a}function o(t){var e={};return t&&t.forEach(function(t){e[t.name]=""}),e}function l(t){return t.map(function(t){return t.title})}function p(t){return t.map(function(t){return{data:t.name}})}function r(){g&&t("#wpt-form input[name=data]").val(JSON.stringify(u.getSourceData())),m=!0,t("#wpt-form").submit()}function c(e,n,i){var a=t("input[name='fields["+e+"]["+n+"]']");return i?a.prop(i):a.val()}function d(e,n,i){return t("input[name='fields["+e+"]["+n+"]']").val(i)}function s(){var e=t("#wpt-edit-field-dialog #wpt-format-input").val(),n=numeral(1e3).format(e),i=t("#wpt-edit-field-dialog #wpt-currency-input").val();i&&i.length>0&&(n=n.replace(/\$/g,i)),t("#wpt-format-preview").text(n)}t(".wpt-shortcode").click(function(){wpt_admin.selectText(this)}),t("#wpt-fields tbody").sortable({handle:".wpt-drag-handle"}),t("#wpt-fields #wpt-edit-field-btn").click(function(){var e=t(this).closest("tr"),n=e.attr("data-field"),i=t("#wpt-edit-field-dialog");i.attr("data-field",n),t("#wpt-field-name",i).text(t("#wpt-title-input",e).val()),t("#wpt-format-input",i).val(c(n,"format")),t("#wpt-currency-input",i).val(c(n,"currency_symbol")),t("#wpt-type-select",i).val(c(n,"type")).change(),t("#wpt-align-select",i).val(c(n,"align")),t("#wpt-width-input",i).val(c(n,"width")),t("#wpt-class-input",i).val(c(n,"css")),h&&t("#wpt-edit-field-dialog #wpt-remove-field-btn").attr("href",h.replace("__field__",n)),w.open()}),t("#wpt-fields #wpt-title-input").on("input",function(){if(v=!0,u){var n=t(this).closest("tr").attr("data-field"),i=t(this).val();e.fields.forEach(function(t){t.name==n&&(t.title=i)}),u.updateSettings({colHeaders:l(e.fields,u.getSourceData())})}}),t("#wpt-fields .wpt-col-check input").change(function(){v=!0}),t("#wpt-edit-field-dialog #wpt-apply-btn").click(function(){var e=t("#wpt-edit-field-dialog"),n=e.attr("data-field");d(n,"type",t("#wpt-type-select",e).val()),d(n,"format",t("#wpt-format-input",e).val()),d(n,"currency_symbol",t("#wpt-currency-input",e).val()),d(n,"align",t("#wpt-align-select",e).val()),d(n,"width",t("#wpt-width-input",e).val()),d(n,"css",t("#wpt-class-input",e).val()),w.close(),r()}),t("#wpt-edit-field-dialog #wpt-remove-field-btn").click(function(t){confirm(wpt_consts.confirm_delete_table_field)||t.preventDefault()}),t("#wpt-edit-field-dialog #wpt-format-input").on("input",s),t("#wpt-edit-field-dialog #wpt-currency-input").on("input",s),t("#wpt-edit-field-dialog #wpt-type-select").change(function(){if("number"==t(this).val()){var e=t("#wpt-edit-field-dialog");""==c(e.attr("data-field"),"format")&&t("#wpt-format-input",e).val("0,0.00"),s(),t("#wpt-edit-field-dialog #wpt-format-row").show()}else t("#wpt-edit-field-dialog #wpt-format-row").hide()}),t('#wpt-options input[name="config[paging]"]').change(function(){var e=t(this).prop("checked");t('#wpt-options input[name="config[pageSize]"]').prop("disabled",!e)}),t("#wpt-options input, #wpt-options select").on("change",i),t("#wpt-options input, #wpt-options select").on("input",i),t("#wpt-submit-btn").click(r),t("#wpt-update-query-btn").click(r),t("#wpt-preview-btn").click(function(){var n=[];t("#wpt-fields tbody tr").each(function(){var e=t(this).attr("data-field");c(e,"visible","checked")&&n.push({name:e,title:c(e,"title"),type:c(e,"type"),format:c(e,"format"),align:c(e,"align"),width:c(e,"width"),css:c(e,"css"),currency_symbol:c(e,"currency_symbol")})}),t("#wpt-preview").attr("class","jsgrid "+t("select[name='config[theme]']").val()),t("#wpt-preview").parent().width(window.innerWidth-200),t("#wpt-preview").parent().height(window.innerHeight-200);t("#wpt-preview").jsGrid({controller:{loadData:function(){return u?u.getSourceData():t.ajax({type:"GET",url:e.load_data_url.replace(/&amp;/gi,"&")})}},width:"100%",autoload:!0,sorting:t("input[name='config[sorting]']").prop("checked"),selecting:t("input[name='config[selecting]']").prop("checked"),heading:t("input[name='config[heading]']").prop("checked"),paging:t("input[name='config[paging]']").prop("checked"),pageSize:t("input[name='config[pageSize]']").val(),fields:n});f.open()}),t("#wpt-data #wpt-add-rows-btn").click(function(){var e=t("#wpt-add-rows-inp").val();!isNaN(e)&&e>0&&(u.alter("insert_row",u.countRows(),e),u.render())});var w=t("#wpt-edit-field-dialog").wptDialog(),f=t("#wpt-preview-dialog").wptDialog(),u=null,g=!1,h=t("#wpt-edit-field-dialog #wpt-remove-field-btn").attr("href"),m=!1,v=!1,b=!1;t(window).bind("beforeunload",function(){if(!m&&n())return"Are you sure you want to leave?"}),t("#wpt-data-sheet").length>0&&t.ajax({type:"GET",url:e.load_data_url.replace(/&amp;/gi,"&"),success:function(e){u=a(t("#wpt-data-sheet").get(0),e)}});var y={};e.fields.forEach(function(t){y[t.name]=t});var _={left:"htLeft",center:"htCenter",right:"htRight"}},t.fn.wptDialog=function(e){var n=t(this);n.hide(),n.addClass("wpt-dialog"),t(document.body).append(n);var i=t("<div/>").addClass("wpt-dialog-overlay"),a={};return a.open=function(){n.show(),n.css("top",Math.max(0,(t(window).height()-n.height())/2)+"px"),n.css("left",Math.max(0,(t(window).width()-n.width())/2)+"px"),t(document.body).append(i)},a.close=function(){n.hide(),i.detach()},i.click(function(){a.close()}),t(".wpt-close-btn",n).click(function(){a.close()}),a},t.fn.wptTabs=function(e){function n(){var n=t(".nav-tab-active",i).attr("href");t(".wpt-tab-content",i).hide(),t(n,i).show(),null!=e.change&&e.change.call(this,t(".nav-tab-active",i))}var i=t(this);e=e||{},t(".nav-tab",i).click(function(e){e.preventDefault(),t(".nav-tab",i).removeClass("nav-tab-active"),t(this).addClass("nav-tab-active"),n()}),n()},t.fn.wptFileDrop=function(e){e=e||{};var n=t(this);n.css("position","relative");var i=n.find("input[type=file]");i.css("position","absolute").css("left",0).css("top",0).css("opacity",0),i.change(function(t){if(e.change){var a=i[0].files&&i[0].files.length>0?i[0].files[0]:null;e.change.call(n,a)}}),n.on("dragover",function(t){t.preventDefault(),t.stopPropagation(),n.toggleClass("wpt-drop",!0);var e=n.offset().left,a=n.outerWidth()+e,o=n.offset().top,l=n.outerHeight()+o,p=t.pageX,r=t.pageY;p<e||p>a||r<o||r>l?i.offset({top:-400,left:-400}):i.offset({top:r-15,left:p-100})}),n.on("dragleave",function(){n.toggleClass("wpt-drop",!1)}),n.on("drop",function(t){n.toggleClass("wpt-drop",!1);var a=t.originalEvent.dataTransfer,o=null;a.items&&a.items.length>0?o=a.items[0].getAsFile():a.files&&a.files.length>0&&(o=a.files[0]),o&&o.type!=i.attr("accept")&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),e.error&&e.error.call(n,'Only files with type "'+i.attr("accept")+'" is allowed.'))}),n.find(".wpt-filedrop-btn").click(function(){i.click()})}}(jQuery);